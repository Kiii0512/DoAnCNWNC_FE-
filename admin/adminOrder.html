<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Quản lý đơn hàng — Shop68IT1</title>

  <!-- CSS chung + page-specific -->
  <link rel="stylesheet" href="./assets/css/bienChung.css" />
  <link rel="stylesheet" href="./assets/css/header.css" />
  <link rel="stylesheet" href="./assets/css/menu.css" />
  <link rel="stylesheet" href="./assets/css/adminOrder.css" />
</head>
<body>
  <!-- =====================
       Header (partial)
       - Server-side include (nếu server hỗ trợ): uncomment hoặc dùng server include
       - Fallback client-side loader sẽ fetch ./partials/headerAdmin.html nếu cần
       ===================== -->
  <!--#include file="partials/headerAdmin.html" -->
  <div id="headerPlaceholder" data-partial="./partials/headerAdmin.html"></div>

  <!-- =====================
       Menu (partial)
       - Server-side include (nếu server hỗ trợ)
       - Fallback client-side loader sẽ fetch ./partials/menuAdmin.html nếu cần
       ===================== -->
  <!--#include file="partials/menuAdmin.html" -->
  <div id="menuPlaceholder" data-partial="./partials/menuAdmin.html"></div>

  <!-- ===== Main content ===== -->
  <main>
    <div class="card">
      <div class="page-head">
        <div class="page-title">
          <h2 style="margin:0">Admin — Quản lý đơn hàng</h2>
          <div class="small muted">Danh sách, xem, cập nhật trạng thái, in & export</div>
        </div>
        <div class="controls">
          <button class="btn btn-ghost" id="btnLamMoi">Làm mới</button>
          <button class="btn btn-ghost" id="btnXuat">Xuất CSV</button>
        </div>
      </div>

      <div class="filters">
        <input type="text" id="timKiem" placeholder="Tìm theo tên, mã, số điện thoại..." style="min-width:280px" />
        <select id="locTrangThai" aria-label="Lọc trạng thái">
          <option value="">Tất cả trạng thái</option>
          <option value="dang-cho">Đang chờ</option>
          <option value="da-xac-nhan">Đã xác nhận</option>
          <option value="dang-chuan-bi">Đang chuẩn bị</option>
          <option value="da-gui">Đã gửi</option>
          <option value="da-hoan-thanh">Hoàn thành</option>
          <option value="da-huy">Đã hủy</option>
        </select>
        <select id="soLuongTrang" aria-label="Số dòng">
          <option>10</option>
          <option>25</option>
          <option>50</option>
        </select>
        <div style="margin-left:auto" class="inline">
          <label class="small muted">Chọn:</label>
          <button class="btn btn-ghost" id="inChon">In</button>
          <button class="btn btn-ghost" id="xuatChon">Xuất chọn</button>
        </div>
      </div>

      <div style="overflow:auto">
        <table id="bangDon" aria-describedby="Danh sách đơn hàng">
          <thead>
            <tr>
              <th style="width:36px"><input type="checkbox" id="chkTatCa" aria-label="Chọn tất cả"/></th>
              <th>Mã đơn</th>
              <th>Khách</th>
              <th>Thanh toán</th>
              <th>Trạng thái</th>
              <th>Ngày</th>
              <th style="width:190px">Thao tác</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- ===== Drawer chi tiết đơn (giữ trong file này) ===== -->
  <aside class="drawer" id="khungChiTiet" aria-hidden="true">
    <button id="dongKhung" class="btn btn-ghost" style="float:right">Đóng</button>
    <h3>Chi tiết đơn <span id="chiTietMa" class="small muted"></span></h3>
    <div id="chiTietKhach" class="khung-thong-tin"></div>

    <div style="margin-top:10px">
      <label class="small muted">Trạng thái</label>
      <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
        <select id="chiTietTrangThai" style="padding:8px 10px;border-radius:8px;border:1px solid #e6e7eb">
          <option value="dang-cho">Đang chờ</option>
          <option value="da-xac-nhan">Đã xác nhận</option>
          <option value="dang-chuan-bi">Đang chuẩn bị</option>
          <option value="da-gui">Đã gửi</option>
          <option value="da-hoan-thanh">Hoàn thành</option>
          <option value="da-huy">Đã hủy</option>
        </select>
        <button id="luuTrangThai" class="btn btn-primary">Lưu trạng thái</button>
        <button id="inDon" class="btn btn-ghost">In đơn</button>
      </div>
    </div>

    <div class="product-list" id="chiTietSanPham"></div>
    <div style="margin-top:12px" id="chiTietTong"></div>
  </aside>

  <!-- ===== Toast (giữ trong file này) ===== -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- ===== Fallback client-side partial loader (nếu bạn không dùng server-side include) ===== -->
  <script>
    (function loadPartialsIfNeeded() {
      // Nếu server-side include đã chèn partials, placeholders sẽ rỗng -> nothing to do.
      // Nếu placeholders còn rỗng (chưa bị SSI thay thế), fetch partials từ ./partials/* và inject.
      const parts = [
        { sel: '#headerPlaceholder', url: './partials/headerAdmin.html' },
        { sel: '#menuPlaceholder', url: './partials/menuAdmin.html' }
      ];

      function fetchAndInject(p) {
        const el = document.querySelector(p.sel);
        if (!el) return Promise.resolve();
        // nếu already has content (server include), skip
        if (el.children.length > 0 || el.innerHTML.trim().length > 0) return Promise.resolve();
        return fetch(p.url, { cache: 'no-store' })
          .then(r => {
            if (!r.ok) throw new Error('Không tải được partial: ' + p.url);
            return r.text();
          })
          .then(html => { el.innerHTML = html; })
          .catch(err => { console.warn(err); /* silent fail: server should serve partials in production */ });
      }

      // fetch both partials in parallel, then dispatch an event so other scripts can rely on DOM
      Promise.all(parts.map(fetchAndInject)).then(() => {
        // notify that partials loaded (useful if menu.js is loaded later)
        window.dispatchEvent(new Event('adminPartialsLoaded'));
      });
    })();
  </script>

  <!-- ===== Core JS: helpers + menu + page-specific (nạp ở cuối để DOM đã sẵn sàng) ===== -->
  <!-- những file này theo cấu trúc bạn chỉ định: /admin/assets/js/ -->
  <script src="./assets/js/duLieuUtils.js"></script>
  <script src="./assets/js/giaoDienUtils.js"></script>
  <script src="./assets/js/xuatUtils.js"></script>

  <!-- menu.js cần partial menu có sẵn; nó cũng tự kiểm tra và làm việc khi partials được inject -->
  <script src="./assets/js/menu.js"></script>

  <!-- script riêng cho trang adminOrder -->
  <script src="./assets/js/adminOrder.js"></script>

  <!-- ===== Tối thiểu: đảm bảo menu.js khởi tạo sau partial nếu bị tải chậm.
       Nếu bạn dùng client-side partial loading, menu.js lắng nghe event 'adminPartialsLoaded'.
  ===== -->
  <script>
    // Nếu menu.js cần chạy sau partial injection nhưng được tải sớm, dispatch lại refresh
    window.addEventListener('adminPartialsLoaded', function () {
      if (window.__adminMenu && typeof window.__adminMenu.refresh === 'function') {
        try { window.__adminMenu.refresh(); } catch (e) { /* ignore */ }
      }
    });
  </script>
</body>
</html>
